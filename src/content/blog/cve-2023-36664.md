---
author: Jean Chaput
pubDatetime: 2023-12-12T21:48:00Z
title: "CVE-2023-36664 : Ghostscript RCE"
postSlug: cve-2023-36664
featured: true
draft: false
tags:
  - cve
  - poc
description:
  "Détail de l'exploitation de la CVE-2023-36664 et preuve de concept"
---

La `CVE-2023-36664` est parue le 25 juin 2023 et concerne l'interpréteur Ghostscript. Elle permet une exécution de code arbitraire à distance jusqu'à la version `10.01.2`. Le détail de la CVE peut être retrouvé [ici](https://nvd.nist.gov/vuln/detail/CVE-2023-36664).

## Table des matières

## Contexte

### Cadre

Dans le cadre de l'UE Veille de mon master 2 fiabilité et sécurité informatique (AMU), j'ai eu l'occasion de travailer sur la CVE dont il est question dans cet article.

Pour faire simple, le but de cet enseignement est de travailler sur une vulnérabilité récente (dans le référentiel de la formation) pour laquelle une preuve de concept a été publiée. L'objet de ce travail est de comprendre l'apparition de la vulnérabilité, son exploitabilité et de produire une démonstration reproductible afin de présenter tout cela au cours d'un séminaire.

Ce qui se trouve dans cet article est simplement un petit condensé du travail fourni afin de mettre en valeur mes contributions personelles. Les explications sont volontairement réduites et simplifiées mais devraient permettre une compréhension générale du problème. Une source plus détaillée d'explications est disponible [ici](https://www.kroll.com/en/insights/publications/cyber/ghostscript-cve-2023-36664-remote-code-execution-vulnerability).

Si des erreurs sont présentes ou si l'ensemble manque de détails clés pour la compréhension vous pouvez me contacter.

### Qu'est-ce que Ghostscript ?

Ghostscript est un interpréteur pour le language PostScript développé par Adobe (pour les plus dinosaures d'entre-nous, grossièrement "ancêtre" du PDF). Il s'agit d'un logiciel maintenu en source libre sous une licence GNU Affero GPL mais aussi sous une licence commerciale par la société Artifex.

Le code souce est disponible sur [la page Github](https://github.com/ArtifexSoftware) de Artifex Software.

## Vulnérabilité

### Vue d'ensemble

> Artifex Ghostscript through 10.01.2 mishandles permission validation for pipe devices (with the %pipe% prefix or the | pipe character prefix).

Lorsque l'on s'intéresse à la description ci-dessus, on comprend que la vulnérabilité réside dans une mauvaise validation des permissions lors de l'utilisation d'un [pipe](https://man.archlinux.org/man/extra/man-pages-fr/pipe.2.fr).

En réalité, si l'on regarde d'un peu plus près [le commit de correction](https://github.com/ArtifexSoftware/ghostpdl/commit/5f56c6f6f989816fc9cc671116740acecbed5b6c#diff-bbe58001c850a96f31437583f72fe9145a87208e15ffe6ffa66113813aecf192R1080) de la vulnérabilité, on arrive à identifier la fonction de validation qui à l'air de nous poser problème. Il s'agit de la fonction `gp_validate_path_len`.

Le mécanisme de validation de cette fonction est assez simple. Celle-ci prend en paramètre un chemin d'accès (entre-autre) et procède à la réduction de ce chemin grâce à la fonction `gp_file_name_reduce`. Cette réduction consiste en une simplification du chemin d'accès en supprimant notamment les références au répertoire courant et au répertoire parent (resp. `./` et `../`). La validation des permissions d'accès s'effectue ensuite sur ce chemin réduit avant l'ouverture du pipe et **l'utilisation du chemin complet**.

Le problème se trouve à cet endroit précis puisque le chemin validé est un chemin ayant reçu un traitement de plus que le chemin utilisé.

### Payload

Si ce n'est pas encore très clair à ce stade, vous pouvez vous référer à [cet article](https://blog.redteam-pentesting.de/2023/ghostscript-overview/) qui explique très bien comment contourner cette validation de chemin dans un but offensif.

Il est tout d'abord important de préciser que l'interpréteur Ghostscript à le droit de lire et d'écrire seulement dans certains fichiers prédéfinis. C'est par exemple le cas du répertoire `%rom%lib/` qui est accessible en lecture.

Pour résumer ce qu'il se passe en pratique, prenons la commande `(%pipe%firefox;/../%rom%lib/test) (r) file` qui est une simple commande d'ouverture d'un fichier en écriture dans laquelle on utilise un pipe. Le chemin réduit est alors `%rom%lib/test` or on a vu dans le paragraphe précédent que le répertoire `%rom%lib/` est bien accessible en lecture. Ainsi la validation réussit et Firefox est déclenché lors de la tentative d'ouverture du fichier. Si cette commande est insérée dans un fichier `.ps` ou `.eps` décrivant une image, l'exécution de Firefox est déclenchée à l'ouverture de celle-ci.

## Preuve de concept

L'article accessible [ici](https://www.kroll.com/en/insights/publications/cyber/ghostscript-cve-2023-36664-remote-code-execution-vulnerability) explicant assez bien la vulnérabilité mais ne partageant pas le code de la preuve de concept, je me suis permis d'en développer une très simplifée qui est accessible librement sur [mon Github](https://github.com/JeanChpt/CVE-2023-36664).

Celle-ci sera très certainement mise à jour lorsque le temps me le permettra avec notamment une image permettant de tester plus facilement l'exploitation. En attendant il suffit de convertir n'importe quelle image en fichier `.eps` avec un convertisseur en ligne pour ensuite l'utiliser.

Au niveau des prérequis, seule une version `10.01.1` de Ghostscript est requise et peut-être installée avec les commandes ci-dessous.

```sh
git clone -b gs10.01.1 https://github.com/ArtifexSoftware/ghostpdl.git
cd ghostpdl
sh autogen.sh
make
make install
```

Pour plus d'informations sur l'utilisation vous pouvez vous fier au `README` du dépôt Github correspondant.

## Mise en garde

La preuve de concept présentée dans cet article est très simplifiée et développée dans un but pédagogique uniquement (pour des tests en machine virtuelle).

Ce travail a été inspiré par les ressources citées tout au long de l'article et des erreurs peuvent s'y être glissées. Si tel est le cas n'hésitez pas à me les faire remonter.